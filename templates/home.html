{% extends "base.html" %}
{% block content %}
<div class="dashboard-main">
  {% set expected = admin_summary.horas_esperadas %}
  {% set worked = admin_summary.horas_trabajadas %}
  {% set completion = (worked / expected * 100) if expected else 0 %}

  <div class="grid two-cols">
    <article class="card welcome-card">
      <div>
        <p class="tag">Dashboard admin</p>
        <h1>Hola, {{ active_collaborator.full_name if active_collaborator else 'Equipo Kimce' }} üëã</h1>
        <p class="page-subtitle">Aqu√≠ tienes tu resumen de hoy: horas del equipo, solicitudes y eventos prioritarios.</p>
        <div class="chip-row" style="margin-top:0.8rem; gap:0.5rem;">
          <span class="status-chip green">{{ active_today|length }} activos ahora</span>
          <span class="status-chip amber">{{ pending_requests|length }} solicitudes</span>
          <span class="status-chip blue">{{ access_counts.pending }} accesos pendientes</span>
        </div>
      </div>
      <div class="hero-illustration" aria-hidden="true"></div>
    </article>

    <article class="card gradient">
      <div class="pill-header" style="align-items:flex-start;">
        <div>
          <p class="tag">Semana del equipo</p>
          <h3 style="margin:0;">Horas trabajadas vs esperadas</h3>
          <p class="quiet-label">Formato HH:MM ¬∑ curva suave</p>
        </div>
        <div class="pill-count">{{ completion|round(1) }}% cumplimiento</div>
      </div>
      <div class="line-chart soft" aria-hidden="true">
        <svg viewBox="0 0 320 140" preserveAspectRatio="none">
          <defs>
            <linearGradient id="lineGradientAdmin" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#3f7aff" stop-opacity="0.5" />
              <stop offset="100%" stop-color="#3f7aff" stop-opacity="0" />
            </linearGradient>
          </defs>
          <path d="M0 110 C60 80 80 95 120 70 S200 40 260 60 320 30 320 30" fill="none" stroke="#3f7aff" stroke-width="3" stroke-linecap="round" />
          <path d="M0 110 C60 80 80 95 120 70 S200 40 260 60 320 30 320 30" fill="url(#lineGradientAdmin)" stroke="none" opacity="0.25" />
        </svg>
      </div>
      <div class="stat-grid" style="margin-top:0.6rem;">
        <div class="stat-card">
          <p class="stat-label">Trabajadas</p>
          <p class="stat-value">{{ worked|hhmm }}</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Esperadas</p>
          <p class="stat-value">{{ expected|hhmm }}</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Horas extra</p>
          <p class="stat-value">{{ admin_summary.horas_extra|hhmm }}</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Saldo</p>
          <p class="stat-value">{{ admin_summary.horas_a_favor|hhmm }}</p>
        </div>
      </div>
    </article>
  </div>

  <div class="grid two-cols">
    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Notificaciones importantes</p>
          <h3 style="margin:0;">Pendientes y avisos</h3>
          <p class="quiet-label">Solicitudes, fichajes y vacaciones pr√≥ximas.</p>
        </div>
        <a class="ghost-link" href="{{ url_for('admin_view') }}#solicitudes">Ver todas ‚Üí</a>
      </div>
      <div class="stacked-list">
        {% for req in pending_requests[:3] %}
        <div class="list-row">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">{{ req.request_type.value }}</p>
            <h4 style="margin:0.2rem 0 0;">{{ collaborators.get(req.collaborator_id).full_name if collaborators.get(req.collaborator_id) else req.collaborator_id }}</h4>
            <p class="quiet-label">{{ req.payload.get('inicio', 'Sin fecha') }}</p>
          </div>
          <span class="status-chip amber">Pendiente</span>
        </div>
        {% endfor %}
        {% for ann in announcements[:3] %}
        <div class="list-row">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">Anuncio</p>
            <h4 style="margin:0.2rem 0 0;">{{ ann.title }}</h4>
            <p class="quiet-label">{{ ann.body }}</p>
          </div>
          <span class="status-chip blue">Info</span>
        </div>
        {% endfor %}
        {% if pending_requests|length == 0 and announcements|length == 0 %}
        <p class="muted">Sin notificaciones nuevas.</p>
        {% endif %}
      </div>
    </article>

    <article class="card" id="mini-calendar">
      <div class="pill-header">
        <div>
          <p class="tag">Calendario r√°pido</p>
          <h3 style="margin:0;">Mes en curso</h3>
          <p class="quiet-label">Fichajes, feriados, vacaciones y eventos.</p>
        </div>
        <a class="ghost-link" href="{{ url_for('admin_view') }}#calendario">Calendario completo ‚Üí</a>
      </div>
      <div class="mini-calendar-grid">
        {% for week in month_grid %}
        <div class="mini-week">
          {% for day in week %}
          {% set events = events_by_day.get(day, []) %}
          <button type="button" class="day-cell {% if day == today %}selected{% endif %} {% if day.month != today.month %}muted{% endif %}" data-day-select="{{ day.isoformat() }}">
            <span class="day-number">{{ day.day }}</span>
            {% if events %}<span class="dot"></span>{% endif %}
            <small>{{ events|length }} eventos</small>
          </button>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
      <div class="day-detail-panels">
        {% for week in month_grid %}
          {% for day in week %}
          {% set events = events_by_day.get(day, []) %}
          {% set totals = day_totals.get(day) %}
          <div class="day-detail {% if day == today %}active{% endif %}" data-day-panel="{{ day.isoformat() }}">
            <div class="chip-row" style="justify-content:space-between;">
              <strong>{{ day.strftime('%d %b %Y') }}</strong>
              <span class="status-chip blue">{{ events|length }} eventos</span>
            </div>
            <p class="quiet-label">Horas del equipo: {{ totals.worked|hhmm }} / {{ totals.expected|hhmm }}</p>
            <ul class="clean-list" style="margin-top:0.5rem;">
              {% for ev in events %}
              <li class="list-row" style="padding:0.35rem 0;">
                <div class="list-row__main">
                  <p class="tag" style="margin:0;">{{ ev.collaborator_id or 'Equipo' }}</p>
                  <strong>{{ ev.title }}</strong>
                  <p class="quiet-label">{{ ev.start.strftime('%d/%m %H:%M') }} - {{ ev.end.strftime('%d/%m %H:%M') }}</p>
                </div>
                <span class="ghost-link">Ver ‚Üí</span>
              </li>
              {% else %}
              <li class="muted">Sin eventos para este d√≠a.</li>
              {% endfor %}
            </ul>
          </div>
          {% endfor %}
        {% endfor %}
      </div>
    </article>
  </div>

  <div class="grid two-cols">
    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Acciones r√°pidas</p>
          <h3 style="margin:0;">Tareas de hoy</h3>
          <p class="quiet-label">Gestiona solicitudes, accesos, feriados y vacaciones.</p>
        </div>
      </div>
      <div class="quick-actions">
        <a class="pill-button" href="{{ url_for('admin_view') }}#solicitudes">Revisar solicitudes</a>
        <a class="pill-button" href="{{ url_for('admin_view') }}#accesos">Revisar accesos</a>
        <a class="pill-button" href="{{ url_for('admin_view') }}#feriados">Crear feriado</a>
        <a class="pill-button" href="{{ url_for('admin_view') }}#calendario">Asignar vacaciones</a>
      </div>
    </article>

    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">KPIs r√°pidos</p>
          <h3 style="margin:0;">Estado del equipo</h3>
          <p class="quiet-label">Indicadores circulares estilo referencia.</p>
        </div>
      </div>
      <div class="kpi-grid">
        <div class="kpi">
          <div class="donut" style="--percent: {{ completion|round(1) }};"><span>{{ completion|round(0) }}%</span></div>
          <p class="quiet-label">Horas marcadas</p>
        </div>
        <div class="kpi">
          <div class="donut amber" style="--percent: {{ requests_completion }};"><span>{{ requests_completion }}%</span></div>
          <p class="quiet-label">Solicitudes completadas</p>
        </div>
        <div class="kpi">
          {% set online = active_today|length %}
          {% set total = collaborator_cards|length %}
          {% set online_pct = (online / total * 100) if total else 0 %}
          <div class="donut green" style="--percent: {{ online_pct|round(0) }};"><span>{{ online }} / {{ total }}</span></div>
          <p class="quiet-label">Conectados ahora</p>
        </div>
        <div class="kpi">
          {% set extra_pct = (admin_summary.horas_extra / expected * 100) if expected else 0 %}
          <div class="donut blue" style="--percent: {{ extra_pct|round(0) }};"><span>{{ admin_summary.horas_extra|hhmm }}</span></div>
          <p class="quiet-label">Horas extra del mes</p>
        </div>
      </div>
    </article>
  </div>

  <div class="grid two-cols">
    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Eventos pr√≥ximos</p>
          <h3 style="margin:0;">Activaciones y vacaciones</h3>
          <p class="quiet-label">Inspirado en el widget ‚ÄúBoard meeting‚Äù.</p>
        </div>
      </div>
      {% set ns = namespace(events=[]) %}
      {% for ev in calendar %}
        {% if ev.start.date() >= today %}
          {% set ns.events = ns.events + [ev] %}
        {% endif %}
      {% endfor %}
      <div class="stacked-list">
        {% for ev in ns.events[:4] %}
        <div class="list-row">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">{{ ev.collaborator_id or 'Equipo' }}</p>
            <h4 style="margin:0.2rem 0 0;">{{ ev.title }}</h4>
            <p class="quiet-label">{{ ev.start.strftime('%d/%m %H:%M') }} ¬∑ {{ ev.end.strftime('%d/%m %H:%M') }}</p>
          </div>
          <span class="ghost-link">Reprogramar</span>
        </div>
        {% else %}
        <p class="muted">Sin eventos pr√≥ximos.</p>
        {% endfor %}
      </div>
    </article>

    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Solicitudes recientes</p>
          <h3 style="margin:0;">Aprobar o denegar</h3>
          <p class="quiet-label">Vacaciones, permisos y actividades especiales.</p>
        </div>
        <a class="ghost-link" href="{{ url_for('admin_view') }}#solicitudes">Ver historial ‚Üí</a>
      </div>
      <div class="stacked-list">
        {% for req in pending_requests[:5] %}
        <div class="list-row" style="grid-template-columns:1fr auto;">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">{{ req.request_type.value }}</p>
            <h4 style="margin:0.2rem 0 0;">{{ collaborators.get(req.collaborator_id).full_name if collaborators.get(req.collaborator_id) else req.collaborator_id }}</h4>
            <p class="quiet-label">{{ req.payload.get('inicio', 'Sin fecha') }}</p>
          </div>
          <div style="display:flex; gap:0.4rem;">
            <form method="post" action="{{ url_for('admin_request_decision', collaborator_id=req.collaborator_id) }}">
              <input type="hidden" name="request_id" value="{{ req.request_id }}" />
              <button class="pill-button" name="action" value="approve">Aprobar</button>
              <button class="pill-button" name="action" value="deny" style="border-color:rgba(185,28,28,0.35); color:#b91c1c;">Denegar</button>
            </form>
          </div>
        </div>
        {% else %}
        <p class="muted">No hay solicitudes pendientes.</p>
        {% endfor %}
      </div>
    </article>
  </div>

  <section class="card" id="accesos">
    <div class="pill-header">
      <div>
        <p class="tag">Accesos y roles</p>
        <h2 style="margin:0;">Solicitudes de acceso</h2>
        <p class="page-subtitle">Ubicadas al final, con layout aireado y controles en l√≠nea.</p>
      </div>
      <div style="display:flex; gap:0.4rem; align-items:center;">
        <span class="pill-count">{{ access_counts.total }} usuarios</span>
        <span class="pill-count pending">{{ access_counts.pending }} pendientes</span>
      </div>
    </div>
    {% if access_requests %}
    <div class="access-list">
      {% for req in access_requests %}
      <article class="access-item" style="grid-template-columns: minmax(280px, 1.3fr) minmax(200px, 1fr) minmax(320px, 1.6fr);">
        <div class="access-user">
          <span class="access-avatar">{{ req.collaborator_name[0] }}</span>
          <div>
            <div class="access-name">{{ req.collaborator_name }}</div>
            <div class="access-sub">
              <span>{{ req.email }}</span>
              <span>‚Ä¢ {{ req.collaborator_id }}</span>
            </div>
          </div>
        </div>
        <div class="access-status">
          {% set status_class = 'gray' %}
          {% if req.status == AccessStatus.PENDING %}{% set status_class = 'amber' %}{% elif req.status == AccessStatus.APPROVED %}{% set status_class = 'green' %}{% endif %}
          <span class="status-chip {{ status_class }}">{{ req.status.value }}</span>
          <p class="micro-copy">Creado {{ req.created_at.strftime('%d/%m %H:%M') }}{% if req.updated_at %} ¬∑ √öltima revisi√≥n {{ req.updated_at.strftime('%d/%m %H:%M') }}{% endif %}</p>
        </div>
        <form method="post" action="{{ url_for('admin_access_decision', email=req.email) }}" class="access-actions">
          <select name="role">
            <option value="{{ Role.COLLABORATOR.value }}" {% if req.desired_role == Role.COLLABORATOR %}selected{% endif %}>Colaborador</option>
            <option value="{{ Role.ADMIN.value }}" {% if req.desired_role == Role.ADMIN %}selected{% endif %}>Admin</option>
          </select>
          <input type="text" name="position" value="{{ req.position or '' }}" placeholder="Puesto" />
          <div class="access-buttons">
            <button type="submit" name="action" value="approve">Aprobar</button>
            <button type="submit" name="action" value="deny" class="button-ghost">Denegar</button>
          </div>
        </form>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <p class="muted">No hay solicitudes de acceso registradas.</p>
    {% endif %}
  </section>
</div>

<script>
  const dayButtons = document.querySelectorAll('[data-day-select]');
  const dayPanels = document.querySelectorAll('[data-day-panel]');
  dayButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-day-select');
      dayButtons.forEach((b) => b.classList.toggle('selected', b === btn));
      dayPanels.forEach((panel) => panel.classList.toggle('active', panel.getAttribute('data-day-panel') === target));
    });
  });
</script>
{% endblock %}
