{% extends "base.html" %}
{% block content %}
<section class="hero">
  <p class="tag">Admin</p>
  <h1>Panel de control</h1>
  <p>
    Gestiona feriados, revisa solicitudes pendientes y monitorea el calendario del equipo en
    un entorno optimizado con énfasis en tonos azules y componentes modernos.
  </p>
</section>
<section class="stat-grid" style="margin:2rem 0 1rem;">
  <div class="stat-card">
    <p class="stat-label">Horas a favor del equipo</p>
    <p class="stat-value">{{ summary.horas_a_favor|hhmm }}</p>
  </div>
  <div class="stat-card">
    <p class="stat-label">Horas en deuda</p>
    <p class="stat-value">{{ summary.horas_deuda|hhmm }}</p>
  </div>
  <div class="stat-card">
    <p class="stat-label">Solicitudes pendientes</p>
    <p class="stat-value">{{ requests|length }}</p>
  </div>
  <div class="stat-card">
    <p class="stat-label">Feriados activos</p>
    <p class="stat-value">{{ holidays|length }}</p>
  </div>
</section>
<div class="card-grid" style="margin-top:1.5rem;">
  <section class="card">
    <h2>Feriados y días especiales</h2>
    {% if holidays %}
    <ul style="list-style:none; padding:0; display:flex; flex-direction:column; gap:0.5rem; margin:1rem 0;">
      {% for holiday in holidays %}
      <li>
        <strong>{{ holiday.day }}</strong> · {{ holiday.name }}
        <span class="tag" style="margin-left:0.5rem;">{{ 'Pagado' if holiday.paid else 'No pagado' }}</span>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p style="color:#475569;">Sin feriados configurados.</p>
    {% endif %}
    <form method="post" action="{{ url_for('admin_create_holiday') }}" style="margin-top:1.5rem;">
      <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
        <label>Nombre<input type="text" name="name" required /></label>
        <label>Fecha<input type="date" name="day" required /></label>
        <label style="flex-direction:row; align-items:center; gap:0.4rem;">
          <input type="checkbox" name="paid" checked /> Pagado
        </label>
        <label style="flex-direction:row; align-items:center; gap:0.4rem;">
          <input type="checkbox" name="compensable" /> Compensable
        </label>
      </div>
      <div style="margin-top:1rem; display:flex; justify-content:flex-end;">
        <button type="submit">Agregar feriado</button>
      </div>
    </form>
  </section>
  <section class="card">
    <h2>Asignar vacaciones</h2>
    <p class="page-subtitle">Crea un bloque aprobado sin esperar solicitud del colaborador.</p>
    <form method="post" action="{{ url_for('admin_assign_vacation') }}" class="stacked-list">
      <label>Colaborador
        <select name="collaborator_id" required>
          <option value="">Selecciona</option>
          {% for portal in collaborators %}
          <option value="{{ portal.collaborator.collaborator_id }}">{{ portal.collaborator.full_name }} ({{ portal.collaborator.collaborator_id }})</option>
          {% endfor %}
        </select>
      </label>
      <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        <label>Inicio<input type="date" name="start" required /></label>
        <label>Fin<input type="date" name="end" /></label>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
        <button type="submit">Asignar vacaciones</button>
      </div>
    </form>
  </section>
  <section class="card">
    <h2>Solicitudes pendientes</h2>
    {% if requests %}
    <div class="stacked-list">
      {% for req in requests %}
      <article class="list-row">
        <div class="list-row__main">
          <p class="tag ghost">{{ req.collaborator_id }}</p>
          <div>
            <h3>{{ req.request_type.value|title }}</h3>
            {% set start = req.payload.get('inicio') %}
            {% set end = req.payload.get('fin') %}
            <p class="page-subtitle">
              {% if start %}{{ start }}{% if end %} → {{ end }}{% endif %}{% endif %}
              {% if req.payload.get('hours') %} · {{ req.payload.get('hours')|hhmm }}{% endif %}
              {% if req.payload.get('activity') %} · {{ req.payload.get('activity') }}{% endif %}
              {% if req.payload.get('notes') %} · {{ req.payload.get('notes') }}{% endif %}
            </p>
          </div>
        </div>
        <form method="post" action="{{ url_for('admin_request_action', request_id=req.request_id) }}" class="list-row__actions">
          <select name="action" required>
            <option value="approve">Aprobar</option>
            <option value="reject">Rechazar</option>
            <option value="correction">Corrección</option>
          </select>
          <input type="text" name="comment" placeholder="Comentario" />
          <button type="submit">Actualizar</button>
        </form>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <p style="color:#475569;">No hay solicitudes pendientes.</p>
    {% endif %}
  </section>
</div>
<section class="card" id="calendario" style="margin-top:2rem;">
  <h2>Calendario del mes</h2>
  {% if calendar %}
  <table>
    <thead>
      <tr>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Título</th>
      </tr>
    </thead>
    <tbody>
      {% for event in calendar %}
      <tr>
        <td>{{ event.start }}</td>
        <td>{{ event.end }}</td>
        <td>{{ event.title }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p style="color:#475569;">No hay eventos registrados.</p>
  {% endif %}
</section>
<section class="card access-card" id="accesos" style="margin-top:1.5rem;">
  <div class="page-header access-header" style="align-items:flex-start;">
    <div>
      <p class="tag">Usuarios y roles</p>
      <h2>Solicitudes de acceso</h2>
      <p class="page-subtitle">Aprueba, cambia rol (Admin/Colaborador), define puesto o bloquea el ingreso.</p>
      <p class="page-subtitle">Los usuarios aparecen automáticamente al iniciar sesión con su correo corporativo.</p>
    </div>
    <div class="access-head-actions">
      <input type="search" placeholder="Buscar por nombre o correo" />
      <div style="display:flex; gap:0.4rem; flex-wrap:wrap; justify-content:flex-end; width:100%;">
        <span class="pill-count">{{ access_counts.total }} usuarios</span>
        <span class="pill-count pending">{{ access_counts.pending }} pendientes</span>
      </div>
    </div>
  </div>
  {% if access_requests %}
  <div class="access-list">
    {% for req in access_requests %}
    <article class="access-item">
      <div class="access-user">
        <span class="access-avatar">{{ req.collaborator_name[0] }}</span>
        <div>
          <div class="access-name">{{ req.collaborator_name }}</div>
          <div class="access-sub">
            <span>{{ req.email }}</span>
            <span>• {{ req.collaborator_id }}</span>
          </div>
        </div>
      </div>
      <div class="access-status">
        {% set status_class = 'gray' %}
        {% if req.status == AccessStatus.PENDING %}{% set status_class = 'amber' %}{% elif req.status == AccessStatus.APPROVED %}{% set status_class = 'green' %}{% endif %}
        <span class="status-chip {{ status_class }}">{{ req.status.value }}</span>
        <p class="micro-copy">Creado {{ req.created_at.strftime('%d/%m %H:%M') }}{% if req.updated_at %} · Última revisión {{ req.updated_at.strftime('%d/%m %H:%M') }}{% endif %}</p>
      </div>
      <form method="post" action="{{ url_for('admin_access_decision', email=req.email) }}" class="access-actions">
        <select name="role">
          <option value="{{ Role.COLLABORATOR.value }}" {% if req.desired_role == Role.COLLABORATOR %}selected{% endif %}>Colaborador</option>
          <option value="{{ Role.ADMIN.value }}" {% if req.desired_role == Role.ADMIN %}selected{% endif %}>Admin</option>
        </select>
        <input type="text" name="position" value="{{ req.position or '' }}" placeholder="Puesto" />
        <div class="access-buttons">
          <button type="submit" name="action" value="approve">Aprobar</button>
          <button type="submit" name="action" value="deny" class="button-ghost">Denegar</button>
        </div>
      </form>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <p style="color:#475569;">No hay solicitudes de acceso registradas.</p>
  {% endif %}
</section>
{% endblock %}
