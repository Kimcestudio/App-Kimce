{% extends "base.html" %}
{% block content %}
<div class="dashboard-main">
  {% set completion = (summary.horas_trabajadas / summary.horas_esperadas * 100) if summary.horas_esperadas else 0 %}

  <div class="grid two-cols">
    <article class="card welcome-card">
      <div>
        <p class="tag">Mi portal</p>
        <h1>Hola, {{ collaborator.full_name }} ðŸ‘‹</h1>
        <p class="page-subtitle">Revisa tus horas, solicitudes y actividades importantes del dÃ­a.</p>
        <div class="chip-row" style="margin-top:0.8rem; gap:0.5rem;">
          <span class="status-chip green">Saldo {{ balance.horas_a_favor|hhmm }}</span>
          <span class="status-chip amber">{{ pending_requests|length }} solicitudes</span>
          <span class="status-chip blue">{{ notifications|length }} avisos</span>
        </div>
      </div>
      <div class="hero-illustration" aria-hidden="true"></div>
    </article>

    <article class="card gradient">
      <div class="pill-header" style="align-items:flex-start;">
        <div>
          <p class="tag">Resumen semanal</p>
          <h3 style="margin:0;">Horas trabajadas vs esperadas</h3>
          <p class="quiet-label">Formato HH:MM Â· lÃ­nea suave</p>
        </div>
        <div class="pill-count">{{ completion|round(1) }}% cumplimiento</div>
      </div>
      <div class="line-chart soft" aria-hidden="true">
        <svg viewBox="0 0 320 140" preserveAspectRatio="none">
          <defs>
            <linearGradient id="lineGradientCollab" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#3f7aff" stop-opacity="0.5" />
              <stop offset="100%" stop-color="#3f7aff" stop-opacity="0" />
            </linearGradient>
          </defs>
          <path d="M0 110 C60 80 80 95 120 70 S200 40 260 60 320 30 320 30" fill="none" stroke="#3f7aff" stroke-width="3" stroke-linecap="round" />
          <path d="M0 110 C60 80 80 95 120 70 S200 40 260 60 320 30 320 30" fill="url(#lineGradientCollab)" stroke="none" opacity="0.25" />
        </svg>
      </div>
      <div class="stat-grid" style="margin-top:0.6rem;">
        <div class="stat-card">
          <p class="stat-label">Trabajadas</p>
          <p class="stat-value">{{ summary.horas_trabajadas|hhmm }}</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Esperadas</p>
          <p class="stat-value">{{ summary.horas_esperadas|hhmm }}</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Horas extra</p>
          <p class="stat-value">{{ summary.horas_extra|hhmm }}</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Saldo</p>
          <p class="stat-value">{{ balance.horas_a_favor|hhmm }}</p>
        </div>
      </div>
    </article>
  </div>

  <div class="grid two-cols">
    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Notificaciones importantes</p>
          <h3 style="margin:0;">Avisos y alertas</h3>
          <p class="quiet-label">Vacaciones, fichajes, actividades especiales.</p>
        </div>
        <a class="ghost-link" href="{{ url_for('collaborator_profile', collaborator_id=collaborator.collaborator_id) }}#notificaciones">Ver todas â†’</a>
      </div>
      <div class="stacked-list">
        {% for note in notifications[:4] %}
        <div class="list-row">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">{{ note.category.value }}</p>
            <h4 style="margin:0.2rem 0 0;">{{ note.body }}</h4>
            <p class="quiet-label">{{ note.created_at.strftime('%d/%m %H:%M') }}</p>
          </div>
          <span class="status-chip {{ note.category.value }}">Aviso</span>
        </div>
        {% else %}
        <p class="muted">Sin notificaciones nuevas.</p>
        {% endfor %}
      </div>
    </article>

    <article class="card" id="mini-calendar-collab">
      <div class="pill-header">
        <div>
          <p class="tag">Mi calendario</p>
          <h3 style="margin:0;">Mes en curso</h3>
          <p class="quiet-label">Fichajes, eventos y vacaciones.</p>
        </div>
        <a class="ghost-link" href="{{ url_for('collaborator_calendar', collaborator_id=collaborator.collaborator_id) }}">Calendario completo â†’</a>
      </div>
      <div class="mini-calendar-grid">
        {% for week in month_grid %}
        <div class="mini-week">
          {% for day in week %}
          {% set events = events_by_day.get(day, []) %}
          <button type="button" class="day-cell {% if day == today %}selected{% endif %} {% if day.month != today.month %}muted{% endif %}" data-day-select="{{ day.isoformat() }}">
            <span class="day-number">{{ day.day }}</span>
            {% if events %}<span class="dot"></span>{% endif %}
            <small>{{ events|length }} eventos</small>
          </button>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
      <div class="day-detail-panels">
        {% for week in month_grid %}
          {% for day in week %}
          {% set events = events_by_day.get(day, []) %}
          {% set totals = day_totals.get(day) %}
          <div class="day-detail {% if day == today %}active{% endif %}" data-day-panel="{{ day.isoformat() }}">
            <div class="chip-row" style="justify-content:space-between;">
              <strong>{{ day.strftime('%d %b %Y') }}</strong>
              <span class="status-chip blue">{{ events|length }} eventos</span>
            </div>
            <p class="quiet-label">Horas registradas: {{ totals.worked|hhmm }} / {{ totals.expected|hhmm }}</p>
            <ul class="clean-list" style="margin-top:0.5rem;">
              {% for ev in events %}
              <li class="list-row" style="padding:0.35rem 0;">
                <div class="list-row__main">
                  <p class="tag" style="margin:0;">{{ ev.category or 'Evento' }}</p>
                  <strong>{{ ev.title }}</strong>
                  <p class="quiet-label">{{ ev.start.strftime('%d/%m %H:%M') }} - {{ ev.end.strftime('%d/%m %H:%M') }}</p>
                </div>
                <span class="ghost-link">Ver â†’</span>
              </li>
              {% else %}
              <li class="muted">Sin eventos para este dÃ­a.</li>
              {% endfor %}
            </ul>
          </div>
          {% endfor %}
        {% endfor %}
      </div>
    </article>
  </div>

  <div class="grid two-cols">
    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Acciones rÃ¡pidas</p>
          <h3 style="margin:0;">Tus tareas de hoy</h3>
          <p class="quiet-label">Fichajes, actividades y saldo.</p>
        </div>
      </div>
      <div class="quick-actions">
        <a class="pill-button" href="{{ url_for('collaborator_view', collaborator_id=collaborator.collaborator_id) }}">Fichar entrada</a>
        <a class="pill-button" href="{{ url_for('collaborator_view', collaborator_id=collaborator.collaborator_id) }}#historial">Ver registro del dÃ­a</a>
        <a class="pill-button" href="{{ url_for('collaborator_calendar', collaborator_id=collaborator.collaborator_id) }}#crear">Crear actividad extra</a>
        <a class="pill-button" href="{{ url_for('collaborator_view', collaborator_id=collaborator.collaborator_id) }}#solicitudes">Solicitar vacaciones</a>
      </div>
    </article>

    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">KPIs rÃ¡pidos</p>
          <h3 style="margin:0;">CÃ³mo vas</h3>
          <p class="quiet-label">Puntualidad y cumplimiento.</p>
        </div>
      </div>
      <div class="kpi-grid">
        <div class="kpi">
          <div class="donut" style="--percent: {{ completion|round(0) }};"><span>{{ completion|round(0) }}%</span></div>
          <p class="quiet-label">Horas cumplidas</p>
        </div>
        <div class="kpi">
          {% set punctuality = collaborator.kpis[0].punctuality if collaborator.kpis else 92 %}
          <div class="donut green" style="--percent: {{ punctuality|round(0) }};"><span>{{ punctuality|round(0) }}%</span></div>
          <p class="quiet-label">Puntualidad mes</p>
        </div>
        <div class="kpi">
          <div class="donut amber" style="--percent: {{ (pending_requests|length * 10)|min(100) }};"><span>{{ pending_requests|length }}</span></div>
          <p class="quiet-label">Solicitudes pendientes</p>
        </div>
        <div class="kpi">
          {% set events_count = upcoming_events|length %}
          {% set events_pct = (events_count / 6 * 100) if events_count else 0 %}
          <div class="donut blue" style="--percent: {{ events_pct|round(0) }};"><span>{{ events_count }}</span></div>
          <p class="quiet-label">Eventos prÃ³ximos</p>
        </div>
      </div>
    </article>
  </div>

  <div class="grid two-cols">
    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Eventos prÃ³ximos</p>
          <h3 style="margin:0;">Lo que se viene</h3>
          <p class="quiet-label">Activaciones, reuniones, vacaciones, feriados.</p>
        </div>
      </div>
      <div class="stacked-list">
        {% for ev in upcoming_events[:4] %}
        <div class="list-row">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">{{ ev.category or 'Evento' }}</p>
            <h4 style="margin:0.2rem 0 0;">{{ ev.title }}</h4>
            <p class="quiet-label">{{ ev.start.strftime('%d/%m %H:%M') }} Â· {{ ev.end.strftime('%d/%m %H:%M') }}</p>
          </div>
          <span class="ghost-link">Ver mÃ¡s</span>
        </div>
        {% else %}
        <p class="muted">No hay eventos prÃ³ximos.</p>
        {% endfor %}
      </div>
    </article>

    <article class="card">
      <div class="pill-header">
        <div>
          <p class="tag">Mis solicitudes</p>
          <h3 style="margin:0;">Estado reciente</h3>
          <p class="quiet-label">Vacaciones, permisos y horas extra.</p>
        </div>
        <a class="ghost-link" href="{{ url_for('collaborator_view', collaborator_id=collaborator.collaborator_id) }}#solicitudes">Ver historial â†’</a>
      </div>
      <div class="stacked-list">
        {% for req in pending_requests[:5] %}
        <div class="list-row" style="grid-template-columns:1fr auto;">
          <div class="list-row__main">
            <p class="tag" style="margin:0;">{{ req.request_type.value }}</p>
            <h4 style="margin:0.2rem 0 0;">{{ req.payload.get('inicio', 'Sin fecha') }}</h4>
            <p class="quiet-label">Creada {{ req.created_at.strftime('%d/%m %H:%M') }}</p>
          </div>
          <span class="status-chip amber">Pendiente</span>
        </div>
        {% else %}
        <p class="muted">No tienes solicitudes pendientes.</p>
        {% endfor %}
      </div>
    </article>
  </div>
</div>

<script>
  const dayButtons = document.querySelectorAll('#mini-calendar-collab [data-day-select]');
  const dayPanels = document.querySelectorAll('#mini-calendar-collab [data-day-panel]');
  dayButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-day-select');
      dayButtons.forEach((b) => b.classList.toggle('selected', b === btn));
      dayPanels.forEach((panel) => panel.classList.toggle('active', panel.getAttribute('data-day-panel') === target));
    });
  });
</script>
{% endblock %}
